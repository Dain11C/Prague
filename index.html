<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <!-- 加入 viewport-fit=cover 以支援全螢幕安全區域 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>布拉格寧靜美學一日遊</title>
    
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts: Playfair Display (Serif) & Inter (Sans) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">

    <style>
        /* 自定義配色與字體 */
        :root {
            --color-bg: #FDFcF8; /* 暖白紙張色 */
            --color-surface: #F5F2EB; /* 燕麥色 */
            --color-primary: #5C6B5D; /* 鼠尾草綠 */
            --color-secondary: #8C8279; /* 亞麻灰 */
            --color-accent: #D4A373; /* 暖木色 */
            --color-text: #2C2C2C; /* 深灰墨色 */
        }

        /* 關鍵修正：鎖定 HTML 和 Body 高度，防止整體頁面彈動 */
        html, body {
            height: 100dvh; /* 使用動態視窗高度 */
            width: 100%;
            overflow: hidden; /* 禁止 Body 捲動，只允許內部 Main 捲動 */
            overscroll-behavior-y: none; /* iOS 關鍵：防止橡皮筋效果 */
            background-color: var(--color-bg);
            color: var(--color-text);
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        h1, h2, h3, .font-serif {
            font-family: 'Playfair Display', serif;
        }

        /* 隱藏捲軸但保留功能 */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* 底部導航欄模糊效果與定位修正 */
        .glass-nav {
            background: rgba(253, 252, 248, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px); /* iOS Safari 支援 */
            border-top: 1px solid rgba(0,0,0,0.05);
            z-index: 50;
            /* 修正：改用 fixed 定位確保不隨內容捲動 */
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            max-width: 28rem; /* 對應 max-w-md */
            margin: 0 auto; /* 居中 */
        }

        /* 輸入框聚焦樣式 */
        .input-focus:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(92, 107, 93, 0.1);
        }

        /* iOS 慣性捲動支援 */
        .ios-scroll {
            -webkit-overflow-scrolling: touch;
        }

        /* 過場動畫 */
        .fade-enter-active, .fade-leave-active {
            transition: opacity 0.3s ease;
        }
        .fade-enter-from, .fade-leave-to {
            opacity: 0;
        }
    </style>
</head>
<body class="max-w-md mx-auto shadow-2xl border-x border-stone-100 relative">

    <div id="app" class="flex flex-col h-full relative">
        
        <!-- 頂部標題區 -->
        <header class="pt-[calc(1rem+env(safe-area-inset-top))] pb-3 px-6 flex justify-between items-end bg-opacity-95 z-20 bg-[#FDFcF8] sticky top-0 border-b border-transparent transition-all shadow-sm/30">
            <div>
                <p class="text-[10px] font-medium tracking-widest text-[#8C8279] uppercase mb-0.5">Dec 16, Monday</p>
                <h1 class="text-2xl font-bold text-[#2C2C2C] font-serif">Prague <span class="text-[#5C6B5D] italic">Quietude</span></h1>
            </div>
            <div class="bg-[#F5F2EB] px-3 py-1.5 rounded-full shadow-sm flex items-center gap-2">
                 <i class="fa-solid fa-snowflake text-[#8C8279] text-xs"></i>
                 <span class="text-[#5C6B5D] font-serif font-medium text-sm">-1°C</span>
            </div>
        </header>

        <!-- 主要內容區 (可捲動) -->
        <!-- 修改：pb-24 改為 pb-20，因為導航欄更矮了 -->
        <main class="flex-1 overflow-y-auto no-scrollbar px-6 pb-20 relative ios-scroll">
            
            <!-- VIEW: 行程表 (Itinerary) -->
            <div v-if="currentTab === 'itinerary'" class="space-y-5 pt-2">
                <div class="relative border-l-2 border-[#E5E0D8] ml-3 space-y-6 py-1">
                    
                    <div v-for="(item, index) in sortedItinerary" :key="item.id" class="relative pl-8 group">
                        <!-- 時間軸圓點 -->
                        <div 
                            class="absolute -left-[9px] top-1 w-5 h-5 rounded-full border-4 border-[#FDFcF8]"
                            :class="item.completed ? 'bg-[#D4A373]' : 'bg-[#5C6B5D]'"
                        ></div>

                        <!-- 行程卡片 -->
                        <div class="bg-white rounded-2xl p-4 shadow-[0_4px_20px_-10px_rgba(0,0,0,0.08)] border border-[#F5F2EB] transition-all active:scale-[0.98]">
                            <div class="flex justify-between items-start mb-1">
                                <span class="text-sm font-semibold text-[#D4A373]">{{ item.time }}</span>
                                <div class="flex gap-2">
                                    <button @click="openMap(item.location)" class="text-[#8C8279] hover:text-[#5C6B5D] transition p-1">
                                        <i class="fa-solid fa-location-arrow text-sm"></i>
                                    </button>
                                    <button @click="editItem(item)" class="text-[#8C8279] hover:text-[#5C6B5D] transition p-1">
                                        <i class="fa-solid fa-pen text-sm"></i>
                                    </button>
                                    <button @click="deleteItem(item.id)" class="text-[#8C8279] hover:text-red-400 transition p-1">
                                        <i class="fa-solid fa-trash text-xs"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <h3 class="text-lg font-serif font-medium text-[#2C2C2C] leading-tight mb-1">{{ item.location }}</h3>
                            <p class="text-xs text-[#8C8279] mb-3 uppercase tracking-wide">{{ item.category }}</p>
                            
                            <div class="text-sm text-[#555] bg-[#F9F8F6] p-3 rounded-xl border border-[#F0EFE9] leading-relaxed">
                                <i class="fa-solid fa-quote-left text-[10px] text-[#D4A373] mr-1 align-top"></i>
                                {{ item.note }}
                            </div>
                        </div>
                    </div>

                </div>

                <!-- 新增行程按鈕 -->
                <button @click="showAddModal = true" class="w-full py-3 rounded-2xl border-2 border-dashed border-[#D4A373] text-[#D4A373] font-medium hover:bg-[#FFFDF9] transition flex items-center justify-center gap-2 text-sm">
                    <i class="fa-solid fa-plus"></i> 新增行程
                </button>
            </div>

            <!-- VIEW: 記帳 (Expenses) -->
            <div v-else-if="currentTab === 'expenses'" class="space-y-6 pt-2 animate-fade-in">
                
                <!-- 匯率設定按鈕 -->
                <div class="flex justify-end">
                    <button @click="showRates = !showRates" class="text-xs text-[#8C8279] hover:text-[#5C6B5D] flex items-center gap-1 underline underline-offset-2">
                        <i class="fa-solid fa-gear"></i> 設定匯率
                    </button>
                </div>

                <!-- 匯率設定區塊 -->
                <div v-if="showRates" class="bg-[#F9F8F6] p-4 rounded-xl border border-[#F0EFE9] text-sm animate-fade-in-up">
                    <h4 class="font-serif mb-3 text-[#2C2C2C]">Exchange Rates (to TWD)</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs text-[#8C8279] mb-1">1 CZK = ? TWD</label>
                            <input v-model.number="rates.CZK" type="number" step="0.01" class="w-full bg-white rounded-lg px-3 py-2 border border-[#E5E0D8] input-focus">
                        </div>
                        <div>
                            <label class="block text-xs text-[#8C8279] mb-1">1 EUR = ? TWD</label>
                            <input v-model.number="rates.EUR" type="number" step="0.01" class="w-full bg-white rounded-lg px-3 py-2 border border-[#E5E0D8] input-focus">
                        </div>
                    </div>
                </div>

                <!-- 總覽卡片 (多幣別顯示) -->
                <div class="bg-[#5C6B5D] text-[#FDFcF8] rounded-3xl p-5 shadow-lg relative overflow-hidden flex flex-col justify-between min-h-[140px]">
                    <div class="absolute -right-6 -top-6 w-32 h-32 bg-[#ffffff] opacity-10 rounded-full blur-2xl"></div>
                    
                    <div>
                        <p class="text-[10px] opacity-70 mb-2 uppercase tracking-widest">Total Expenses</p>
                        <!-- 台幣 (主顯示) -->
                        <div class="flex items-baseline gap-2 mb-1">
                            <span class="text-3xl font-serif font-bold">{{ formatCurrency(totalInTWD, 'TWD') }}</span>
                            <span class="text-xs opacity-60">TWD</span>
                        </div>
                    </div>

                    <!-- 其他幣別 (副顯示) -->
                    <div class="grid grid-cols-2 gap-4 mt-3 pt-3 border-t border-white/10">
                        <div>
                            <p class="text-lg font-serif leading-none">{{ formatCurrency(totalInTWD / rates.CZK, 'CZK') }}</p>
                            <p class="text-[10px] opacity-60 mt-1">CZK (克朗)</p>
                        </div>
                        <div>
                            <p class="text-lg font-serif leading-none">{{ formatCurrency(totalInTWD / rates.EUR, 'EUR') }}</p>
                            <p class="text-[10px] opacity-60 mt-1">EUR (歐元)</p>
                        </div>
                    </div>
                </div>

                <!-- 新增記帳表單 -->
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-[#F5F2EB]">
                    <h3 class="font-serif text-lg mb-3 text-[#2C2C2C]">新增消費</h3>
                    
                    <!-- 金額與幣別 -->
                    <div class="flex gap-2 mb-2">
                        <div class="w-2/3">
                            <input v-model.number="newExpense.amount" type="number" placeholder="金額" class="w-full bg-[#F9F8F6] border-none rounded-xl px-4 py-2.5 text-sm input-focus">
                        </div>
                        <div class="w-1/3">
                            <select v-model="newExpense.currency" class="w-full h-full bg-[#F9F8F6] border-none rounded-xl px-2 text-sm input-focus text-center font-medium text-[#5C6B5D]">
                                <option v-for="curr in currencies" :value="curr">{{ curr }}</option>
                            </select>
                        </div>
                    </div>

                    <!-- 即時換算預覽 -->
                    <div v-if="newExpense.amount" class="mb-2 px-2 py-2 bg-[#F5F2EB] rounded-lg text-xs text-[#8C8279] flex justify-between items-center">
                        <span>≈ {{ formatCurrency(convertCurrency(newExpense.amount, newExpense.currency, 'TWD'), 'TWD') }} TWD</span>
                        <span v-if="newExpense.currency !== 'CZK'">≈ {{ formatCurrency(convertCurrency(newExpense.amount, newExpense.currency, 'CZK'), 'CZK') }} CZK</span>
                        <span v-if="newExpense.currency !== 'EUR'">≈ {{ formatCurrency(convertCurrency(newExpense.amount, newExpense.currency, 'EUR'), 'EUR') }} EUR</span>
                    </div>

                    <!-- 項目名稱 -->
                    <input v-model="newExpense.item" type="text" placeholder="項目 (如: 咖啡)" class="w-full mb-3 bg-[#F9F8F6] border-none rounded-xl px-4 py-2.5 text-sm input-focus">
                    
                    <!-- 分類選擇 -->
                    <div class="flex gap-2 overflow-x-auto pb-2 no-scrollbar mb-3">
                         <span 
                            v-for="cat in expenseCategories" 
                            @click="newExpense.category = cat"
                            :class="newExpense.category === cat ? 'bg-[#D4A373] text-white' : 'bg-[#F5F2EB] text-[#8C8279]'"
                            class="px-3 py-1.5 rounded-full text-xs whitespace-nowrap cursor-pointer transition"
                        >{{ cat }}</span>
                    </div>
                    
                    <button @click="addExpense" class="w-full bg-[#2C2C2C] text-white py-2.5 rounded-xl text-sm font-medium active:scale-95 transition">
                        記帳
                    </button>
                </div>

                <!-- 記帳列表 -->
                <div class="space-y-3">
                    <h3 class="font-serif text-lg text-[#2C2C2C] px-1">消費紀錄</h3>
                    <div v-for="expense in reversedExpenses" :key="expense.id" class="flex justify-between items-center bg-white p-3 rounded-xl shadow-sm border border-[#F5F2EB]">
                        <div class="flex items-center gap-3">
                            <div class="w-9 h-9 rounded-full bg-[#F5F2EB] flex items-center justify-center text-[#5C6B5D]">
                                <i :class="getCategoryIcon(expense.category)"></i>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-[#2C2C2C]">{{ expense.item }}</p>
                                <p class="text-xs text-[#8C8279]">{{ expense.category }}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3 text-right">
                            <div>
                                <span class="block font-serif font-medium text-[#2C2C2C]">{{ expense.amount }} <span class="text-xs">{{ expense.currency }}</span></span>
                                <span v-if="expense.currency !== 'TWD'" class="block text-[10px] text-[#8C8279]">≈ {{ formatCurrency(convertCurrency(expense.amount, expense.currency, 'TWD'), 'TWD') }} TWD</span>
                            </div>
                            <button @click="deleteExpense(expense.id)" class="text-gray-300 hover:text-red-400 ml-2">
                                <i class="fa-solid fa-xmark text-xs"></i>
                            </button>
                        </div>
                    </div>
                    <div v-if="expenses.length === 0" class="text-center py-8 text-[#8C8279] text-sm italic">
                        尚未有消費紀錄
                    </div>
                </div>
            </div>

             <!-- VIEW: 地圖 (Map Placeholder) -->
             <div v-else-if="currentTab === 'map'" class="h-full rounded-2xl overflow-hidden bg-[#F5F2EB] flex flex-col items-center justify-center text-center p-8 relative">
                <!-- 模擬地圖背景 -->
                <div class="absolute inset-0 opacity-10 bg-[url('https://upload.wikimedia.org/wikipedia/commons/thumb/b/bc/Prague_Map.jpg/800px-Prague_Map.jpg')] bg-cover bg-center grayscale"></div>
                
                <div class="relative z-10 bg-white p-6 rounded-2xl shadow-xl max-w-xs">
                    <div class="w-12 h-12 bg-[#5C6B5D] text-white rounded-full flex items-center justify-center mx-auto mb-4 text-xl">
                        <i class="fa-solid fa-map-location-dot"></i>
                    </div>
                    <h3 class="font-serif text-xl mb-2">一鍵導航</h3>
                    <p class="text-sm text-[#8C8279] mb-6">點擊行程表中的「箭頭圖示」，即可開啟 Google Maps 導航至該地點。</p>
                    <button @click="currentTab = 'itinerary'" class="px-6 py-2 bg-[#D4A373] text-white rounded-full text-sm font-medium">
                        回到行程表
                    </button>
                </div>
            </div>

        </main>

        <!-- 底部導航欄 -->
        <!-- 修改：將 pt-2 改為 pt-1，將 0.8rem 改為 0.2rem -->
        <nav class="glass-nav px-6 pb-[calc(0.2rem+env(safe-area-inset-bottom))] pt-1">
            <div class="flex justify-around items-center">
                <button 
                    @click="currentTab = 'itinerary'" 
                    class="flex flex-col items-center gap-0.5 p-1 transition-all duration-300"
                    :class="currentTab === 'itinerary' ? 'text-[#5C6B5D] -translate-y-0.5' : 'text-[#C5C0B6]'"
                >
                    <i class="fa-solid fa-list-ul text-lg"></i>
                    <span class="text-[10px] font-medium tracking-wide">行程</span>
                </button>
                
                <button 
                    @click="currentTab = 'map'" 
                    class="flex flex-col items-center gap-0.5 p-1 transition-all duration-300"
                    :class="currentTab === 'map' ? 'text-[#5C6B5D] -translate-y-0.5' : 'text-[#C5C0B6]'"
                >
                    <i class="fa-regular fa-map text-lg"></i>
                    <span class="text-[10px] font-medium tracking-wide">地圖</span>
                </button>

                <button 
                    @click="currentTab = 'expenses'" 
                    class="flex flex-col items-center gap-0.5 p-1 transition-all duration-300"
                    :class="currentTab === 'expenses' ? 'text-[#5C6B5D] -translate-y-0.5' : 'text-[#C5C0B6]'"
                >
                    <i class="fa-solid fa-wallet text-lg"></i>
                    <span class="text-[10px] font-medium tracking-wide">記帳</span>
                </button>
            </div>
        </nav>

        <!-- Modal: 新增/編輯行程 -->
        <div v-if="showAddModal" class="absolute inset-0 z-[60] bg-black/20 backdrop-blur-sm flex items-end sm:items-center justify-center">
            <div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl animate-fade-in-up mb-[env(safe-area-inset-bottom)]">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-serif text-xl">{{ isEditing ? '編輯行程' : '新增行程' }}</h3>
                    <button @click="closeModal" class="w-8 h-8 rounded-full bg-[#F5F2EB] text-[#8C8279] flex items-center justify-center">
                        <i class="fa-solid fa-times"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs text-[#8C8279] mb-1 ml-1">時間</label>
                        <input v-model="modalForm.time" type="time" class="w-full bg-[#F9F8F6] rounded-xl px-4 py-3 text-sm border-none input-focus">
                    </div>
                    <div>
                        <label class="block text-xs text-[#8C8279] mb-1 ml-1">地點 / 活動</label>
                        <input v-model="modalForm.location" type="text" placeholder="例如: 慕夏博物館" class="w-full bg-[#F9F8F6] rounded-xl px-4 py-3 text-sm border-none input-focus">
                    </div>
                    <div>
                        <label class="block text-xs text-[#8C8279] mb-1 ml-1">分類</label>
                        <select v-model="modalForm.category" class="w-full bg-[#F9F8F6] rounded-xl px-4 py-3 text-sm border-none input-focus appearance-none">
                            <option>藝術 & 文化</option>
                            <option>咖啡 & 美食</option>
                            <option>購物 & 設計</option>
                            <option>景點 & 散步</option>
                            <option>交通 & 郵務</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-[#8C8279] mb-1 ml-1">備註</label>
                        <textarea v-model="modalForm.note" rows="3" placeholder="細節、交通方式..." class="w-full bg-[#F9F8F6] rounded-xl px-4 py-3 text-sm border-none input-focus resize-none"></textarea>
                    </div>
                </div>

                <div class="mt-6">
                    <button @click="saveItineraryItem" class="w-full bg-[#5C6B5D] text-white py-3.5 rounded-xl font-medium shadow-lg shadow-[#5C6B5D]/20 active:scale-95 transition">
                        儲存
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, reactive } = Vue;

        createApp({
            setup() {
                const currentTab = ref('itinerary');
                const showAddModal = ref(false);
                const isEditing = ref(false);
                const editingId = ref(null);
                const showRates = ref(false); // 控制匯率設定顯示

                // 初始行程資料
                const itinerary = ref([
                    { id: 1, time: '09:30', location: '慕夏博物館 (Mucha Museum)', category: '藝術 & 文化', note: '感受新藝術風格的美感。捷運 Můstek 站。' },
                    { id: 2, time: '11:00', location: '布拉格中央郵局', category: '交通 & 郵務', note: '購買郵票並寄出明信片 (Airmail to Taiwan)。' },
                    { id: 3, time: '12:00', location: 'Typika Cafe', category: '咖啡 & 美食', note: '新城區極簡風格精品咖啡，享用輕食午餐。' },
                    { id: 4, time: '13:30', location: 'Kubista Gallery & CZECHDESIGN', category: '購物 & 設計', note: '立體派設計與捷克在地選物。' },
                    { id: 5, time: '14:30', location: '坎帕島 & 列儂牆', category: '景點 & 散步', note: 'Deelive Showroom -> 查理大橋 -> 尋找爬行嬰兒雕塑。' },
                    { id: 6, time: '17:00', location: '佩特任瞭望塔', category: '景點 & 散步', note: '搭乘纜車上山，捕捉黃昏全景。' },
                    { id: 7, time: '18:30', location: '和平廣場聖誕市集 (Náměstí Míru)', category: '景點 & 散步', note: '捷運 A 線 Náměstí Míru 站。在地溫馨市集，喝熱紅酒。' },
                    { id: 8, time: '20:30', location: 'Eska Restaurant', category: '咖啡 & 美食', note: '位於 Karlín 區，細緻高雅的創新捷克菜。需訂位。' }
                ]);

                // 記帳相關設定
                const currencies = ['TWD', 'CZK', 'EUR'];
                
                // 匯率設定 (以 TWD 為基準: 1 外幣 = ? TWD)
                // 預設匯率僅供參考，使用者可自行修改
                const rates = reactive({
                    TWD: 1,
                    CZK: 1.41, 
                    EUR: 35.5
                });

                // 記帳資料 (增加 currency 欄位)
                const expenses = ref([
                    { id: 1, item: '慕夏博物館門票', amount: 350, currency: 'CZK', category: '門票' },
                    { id: 2, item: '郵票', amount: 45, currency: 'CZK', category: '其他' }
                ]);

                const expenseCategories = ['餐飲', '交通', '門票', '購物', '其他'];
                const newExpense = reactive({ item: '', amount: '', currency: 'CZK', category: '餐飲' });
                
                // Modal 表單
                const modalForm = reactive({ time: '', location: '', category: '景點 & 散步', note: '' });

                // Computed
                const sortedItinerary = computed(() => {
                    return [...itinerary.value].sort((a, b) => a.time.localeCompare(b.time));
                });

                // 計算總金額 (轉換為 TWD 基準)
                const totalInTWD = computed(() => {
                    return expenses.value.reduce((sum, item) => {
                        const rate = rates[item.currency] || 1;
                        return sum + (Number(item.amount) * rate);
                    }, 0);
                });

                const reversedExpenses = computed(() => {
                    return [...expenses.value].reverse();
                });

                // Methods
                
                // 貨幣換算邏輯
                const convertCurrency = (amount, fromCurr, toCurr) => {
                    if (!amount) return 0;
                    // 先轉成 TWD
                    const inTWD = amount * rates[fromCurr];
                    // 再轉成目標貨幣
                    return inTWD / rates[toCurr];
                };

                const formatCurrency = (value, currency) => {
                    return new Intl.NumberFormat('cs-CZ', { 
                        minimumFractionDigits: 0, 
                        maximumFractionDigits: 0 
                    }).format(value);
                };

                const getCategoryIcon = (category) => {
                    const icons = {
                        '餐飲': 'fa-mug-hot',
                        '交通': 'fa-train-tram',
                        '門票': 'fa-ticket',
                        '購物': 'fa-bag-shopping',
                        '其他': 'fa-coins'
                    };
                    return `fa-solid ${icons[category] || 'fa-circle'}`;
                };

                const addExpense = () => {
                    if (!newExpense.item || !newExpense.amount) return;
                    expenses.value.push({
                        id: Date.now(),
                        item: newExpense.item,
                        amount: newExpense.amount,
                        currency: newExpense.currency,
                        category: newExpense.category
                    });
                    newExpense.item = '';
                    newExpense.amount = '';
                };

                const deleteExpense = (id) => {
                    expenses.value = expenses.value.filter(e => e.id !== id);
                };

                const openMap = (location) => {
                    const query = encodeURIComponent(location + ', Prague');
                    window.open(`https://www.google.com/maps/search/?api=1&query=${query}`, '_blank');
                };

                const deleteItem = (id) => {
                    if(confirm('確定要刪除此行程嗎？')) {
                        itinerary.value = itinerary.value.filter(i => i.id !== id);
                    }
                };

                const editItem = (item) => {
                    isEditing.value = true;
                    editingId.value = item.id;
                    modalForm.time = item.time;
                    modalForm.location = item.location;
                    modalForm.category = item.category;
                    modalForm.note = item.note;
                    showAddModal.value = true;
                };

                const closeModal = () => {
                    showAddModal.value = false;
                    isEditing.value = false;
                    editingId.value = null;
                    // Reset form
                    modalForm.time = '';
                    modalForm.location = '';
                    modalForm.category = '景點 & 散步';
                    modalForm.note = '';
                };

                const saveItineraryItem = () => {
                    if (!modalForm.time || !modalForm.location) return;

                    if (isEditing.value && editingId.value) {
                        const index = itinerary.value.findIndex(i => i.id === editingId.value);
                        if (index !== -1) {
                            itinerary.value[index] = { ...itinerary.value[index], ...modalForm };
                        }
                    } else {
                        itinerary.value.push({
                            id: Date.now(),
                            ...modalForm
                        });
                    }
                    closeModal();
                };

                return {
                    currentTab,
                    itinerary,
                    sortedItinerary,
                    expenses,
                    reversedExpenses,
                    totalInTWD,
                    newExpense,
                    expenseCategories,
                    currencies,
                    rates,
                    showRates,
                    showAddModal,
                    modalForm,
                    isEditing,
                    convertCurrency,
                    formatCurrency,
                    getCategoryIcon,
                    addExpense,
                    deleteExpense,
                    openMap,
                    deleteItem,
                    editItem,
                    saveItineraryItem,
                    closeModal
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
